# Домашнее задание к занятию «Основы Terraform. Yandex Cloud»

## Чек-лист готовности к домашнему заданию

![Image alt](https://github.com/littlelucidlynx/ter-homeworks/blob/main/02/Screen/Image000.png)

## Задание 1

1. В файле **variables.tf** закомментирована переменная **token**. Токен использовать и передавать я не буду

2. В Yandex Cloud создан сервисный аккаунт с ролью **editor**

![Image alt](https://github.com/littlelucidlynx/ter-homeworks/blob/main/02/Screen/Image001.png)

создан ключ

![Image alt](https://github.com/littlelucidlynx/ter-homeworks/blob/main/02/Screen/Image002.png)

4. На локальной машине сгенерирован новый ssh-ключ и добавлен в ssh-агент, открытая часть записана в переменную **vms_ssh_public_key**

5. При выполнении terraform apply возникают следующие ошибки

```
│ Error: Error while requesting API to create instance: server-request-id = 6ae88b94-4dd8-4da6-ba7b-d138c71e4538 server-trace-id = 963ab222e4b26ef3:dbd8e5f8bd8bc2c9:963ab222e4b26ef3:1 client-request-id = 15c980ea-70b3-472a-aa26-6475a12ac0ea client-trace-id = c4b405a8-9c94-458f-93e1-cf45e1d9e4db rpc error: code = FailedPrecondition desc = Platform "standart-v4" not found
│ 
│   with yandex_compute_instance.platform,
│   on main.tf line 15, in resource "yandex_compute_instance" "platform":
│   15: resource "yandex_compute_instance" "platform" {
│ 
```

Ошибка в наименовании платформы. Необходимо выбрать одну из стандартных [`стандартных платформ`](https://yandex.cloud/ru/docs/compute/concepts/vm-platforms), представленных в описании сервиса:

![Image alt](https://github.com/littlelucidlynx/ter-homeworks/blob/main/02/Screen/Image003.png)


Возьму платформу Intel Ice Lake (**standard-v3**)

---

```
│ Error: Error while requesting API to create instance: server-request-id = 9edf656c-7f82-4755-9016-c3caff99b2f4 server-trace-id = 83485fd54281eb20:c9e72c7a2c53dc2e:83485fd54281eb20:1 client-request-id = 0bc05fd8-378c-4b54-bea9-ef33a83a11ed client-trace-id = 5fac1100-adbf-4b15-9184-52a4da613794 rpc error: code = InvalidArgument desc = the specified core fraction is not available on platform "standard-v3"; allowed core fractions: 20, 50, 100
│ 
│   with yandex_compute_instance.platform,
│   on main.tf line 15, in resource "yandex_compute_instance" "platform":
│   15: resource "yandex_compute_instance" "platform" {
│
```
Ошибка в параметре **core_fraction** (гарантированная доля vCPU). Для платформы Intel Ice Lake (**standard-v3**) допустимыми значениями core_fraction являются 20%, 50%, 100%

![Image alt](https://github.com/littlelucidlynx/ter-homeworks/blob/main/02/Screen/Image004.png)

Возьму гарантированную доступность **20%**

---

```
│ Error: Error while requesting API to create instance: server-request-id = 8daa74d6-189a-43ed-9495-a72eeb14338d server-trace-id = c53adf9cc833c8df:d74f6575d0fc846:c53adf9cc833c8df:1 client-request-id = b4181c66-c0a4-4293-9862-58ad62c2aa49 client-trace-id = a928fdb0-8457-42fd-b52a-15a0ac365b3f rpc error: code = InvalidArgument desc = the specified number of cores is not available on platform "standard-v3"; allowed core number: 2, 4
│ 
│   with yandex_compute_instance.platform,
│   on main.tf line 15, in resource "yandex_compute_instance" "platform":
│   15: resource "yandex_compute_instance" "platform" {
│ 
```

Ошибка в параметре **cores** (ядра vCPU). Минимально возможное количество ядер для платформы Intel Ice Lake (**standard-v3**) - 2

![Image alt](https://github.com/littlelucidlynx/ter-homeworks/blob/main/02/Screen/Image005.png)

Возьму **2** ядра vCPU

6. Подключение по ssh, выполнение команды ```curl ifconfig.me```

![Image alt](https://github.com/littlelucidlynx/ter-homeworks/blob/main/02/Screen/Image006.png)

![Image alt](https://github.com/littlelucidlynx/ter-homeworks/blob/main/02/Screen/Image007.png)

8. Параметры виртуальной машины

[`preemptible`](https://cloud.yandex.ru/docs/compute/concepts/preemptible-vm) - прерываемость виртуальной машины. В случае простоя в течение 24 часов или при нехватке ресурсов для запуска обычной виртуальной машины прерываемая виртуальная машина остановится

[`core_fraction`](https://cloud.yandex.ru/docs/compute/concepts/performance-levels) - доля вычислительного времени физических ядер, которую гарантирует vCPU

Виртуальные машины с данными параметрами **доступны по более низкой цене**, однако **не обеспечивают отказоустойчивости**. Для лабораторных стендов этого достаточно

Итоговый **main.tf**

```
resource "yandex_vpc_network" "develop" {
  name = var.vpc_name
}
resource "yandex_vpc_subnet" "develop" {
  name           = var.vpc_name
  zone           = var.default_zone
  network_id     = yandex_vpc_network.develop.id
  v4_cidr_blocks = var.default_cidr
}

data "yandex_compute_image" "ubuntu" {
  family = "ubuntu-2204-lts"
}
resource "yandex_compute_instance" "vm_web" {
  name        = "netology-develop-platform-web"
  platform_id = "standard-v3"
  resources {
    cores         = 2
    memory        = 1
    core_fraction = 20
  }
  boot_disk {
    initialize_params {
      image_id = data.yandex_compute_image.ubuntu.image_id
    }
  }
  scheduling_policy {
    preemptible = true
  }
  network_interface {
    subnet_id = yandex_vpc_subnet.develop.id
    nat       = true
  }

  metadata = {
    serial-port-enable = true
    ssh-keys           = var.vms_ssh_root_key
  }
}
```

## Задание 2

1. main.tf переименован в main.tf_old, на его основе создан новый main.tf без хардкод значений

```
resource "yandex_vpc_network" "develop" {
  name = var.vpc_name
}
resource "yandex_vpc_subnet" "develop" {
  name           = var.vpc_name
  zone           = var.default_zone
  network_id     = yandex_vpc_network.develop.id
  v4_cidr_blocks = var.default_cidr
}

data "yandex_compute_image" "ubuntu" {
  family = var.vm_web_inage_family
}
resource "yandex_compute_instance" "vm_web" {
  name        = "netology-develop-platform-web"
  platform_id = var.vm_web_platform_id
  resources {
    cores         = var.vm_web_cores
    memory        = var.vm_web_memory
    core_fraction = var.vm_web_core_fraction
  }
  boot_disk {
    initialize_params {
      image_id = data.yandex_compute_image.ubuntu.image_id
    }
  }
  scheduling_policy {
    preemptible = var.vm_web_preemptible
  }
  network_interface {
    subnet_id = yandex_vpc_subnet.develop.id
    nat       = var.vm_web_nat
  }

  metadata = {
    serial-port-enable = var.vm_web_serial_port_enable
    ssh-keys           = var.vms_ssh_root_key
  }

}
```

2. В файле variables.tf объявлены нужные переменные со значениями по умолчанию из main.tf

```
##yandex cloud provider vars
/*
variable "token" {
  type        = string
  description = "OAuth-token; https://cloud.yandex.ru/docs/iam/concepts/authorization/oauth-token"
}
*/

variable "cloud_id" {
  type        = string
  default     = "b1g393ugq43uqc1r3n8a"
  description = "https://cloud.yandex.ru/docs/resource-manager/operations/cloud/get-id"
}

variable "folder_id" {
  type        = string
  default     = "b1guvvhgbqd0n8591q7k"
  description = "https://cloud.yandex.ru/docs/resource-manager/operations/folder/get-id"
}

variable "default_zone" {
  type        = string
  default     = "ru-central1-a"
  description = "https://cloud.yandex.ru/docs/overview/concepts/geo-scope"
}

variable "default_cidr" {
  type        = list(string)
  default     = ["10.0.1.0/24"]
  description = "https://cloud.yandex.ru/docs/vpc/operations/subnet-create"
}

variable "vpc_name" {
  type        = string
  default     = "develop"
  description = "VPC network & subnet name"
}

##ssh

variable "vms_ssh_root_key" {
  type        = string
  default     = "ubuntu:ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAICBJOodclPNPYPA2pyGpmraEW7K7qzSFNOw7SFk9JxUq"
  description = "ssh-keygen -t ed25519"
}

###hardcode vars

variable "vm_web_image_family" {
  type    = string
  default = "ubuntu-2204-lts"
  description = "Image family name"
}

variable "vm_web_name" {
  type    = string
  default = "netology-develop-platform-web"
  description = "Instance name"
}

variable "vm_web_platform_id" {
  type    = string
  default = "standard-v3"
  description = "Instance platform ID"
}

variable "vm_web_cores" {
  type    = string
  default = "2"
  description = "vCPU Cores"
}

variable "vm_web_memory" {
  type    = string
  default = "1"
  description = "Memory size"
}

variable "vm_web_core_fraction" {
  type    = string
  default = "20"
  description = "vCPU Core fraction"
}

variable "vm_web_nat" {
  type    = bool
  default = true
  description = "NAT use"
}

variable "vm_web_serial_port_enable" {
  type    = bool
  default = true
  description = "Serial console port use"
}

variable "vm_web_preemptible" {
  type    = bool
  default = true
  description = "Preemptible use"
}
```

3. Выполнен ```terraform plan``` - изменений нет 

![Image alt](https://github.com/littlelucidlynx/ter-homeworks/blob/main/02/Screen/Image008.png)

## Задание 3

1. Создайте в корне проекта файл 'vms_platform.tf'. Перенесите в него все переменные первой ВМ.
2. Скопируйте блок ресурса и создайте с его помощью вторую ВМ в файле main.tf: **"netology-develop-platform-db"** ,  ```cores  = 2, memory = 2, core_fraction = 20```. Объявите её переменные с префиксом **vm_db_** в том же файле ('vms_platform.tf').  ВМ должна работать в зоне "ru-central1-b"

**vms_platform.tf**

```
##vm_web

variable "vm_web_name" {
  type    = string
  default = "netology-develop-platform-web"
  description = "Instance name"
}

variable "vm_web_platform_id" {
  type    = string
  default = "standard-v3"
  description = "Instance platform ID"
}

variable "vm_web_cores" {
  type    = string
  default = "2"
  description = "vCPU Cores"
}

variable "vm_web_memory" {
  type    = string
  default = "1"
  description = "Memory size"
}

variable "vm_web_core_fraction" {
  type    = string
  default = "20"
  description = "vCPU Core fraction"
}

variable "vm_web_nat" {
  type    = bool
  default = true
  description = "NAT use"
}

variable "vm_web_serial_port_enable" {
  type    = bool
  default = true
  description = "Serial console port use"
}

variable "vm_web_preemptible" {
  type    = bool
  default = true
  description = "Preemptible use"
}

variable "vm_web_zone" {
  type        = string
  default     = "ru-central1-a"
  description = "https://cloud.yandex.ru/docs/overview/concepts/geo-scope"
}

##vm_db

variable "vm_db_name" {
  type    = string
  default = "netology-develop-platform-db"
  description = "Instance name"
}

variable "vm_db_platform_id" {
  type    = string
  default = "standard-v3"
  description = "Instance platform ID"
}

variable "vm_db_cores" {
  type    = string
  default = "2"
  description = "vCPU Cores"
}

variable "vm_db_memory" {
  type    = string
  default = "2"
  description = "Memory size"
}

variable "vm_db_core_fraction" {
  type    = string
  default = "20"
  description = "vCPU Core fraction"
}

variable "vm_db_nat" {
  type    = bool
  default = true
  description = "NAT use"
}

variable "vm_db_serial_port_enable" {
  type    = bool
  default = true
  description = "Serial console port use"
}

variable "vm_db_preemptible" {
  type    = bool
  default = true
  description = "Preemptible use"
}

variable "vm_db_zone" {
  type        = string
  default     = "ru-central1-b"
  description = "https://cloud.yandex.ru/docs/overview/concepts/geo-scope"
}

```

**variables.tf**

```
##yandex cloud provider vars
/*
variable "token" {
  type        = string
  description = "OAuth-token; https://cloud.yandex.ru/docs/iam/concepts/authorization/oauth-token"
}
*/

variable "cloud_id" {
  type        = string
  default     = "b1g393ugq43uqc1r3n8a"
  description = "https://cloud.yandex.ru/docs/resource-manager/operations/cloud/get-id"
}

variable "folder_id" {
  type        = string
  default     = "b1guvvhgbqd0n8591q7k"
  description = "https://cloud.yandex.ru/docs/resource-manager/operations/folder/get-id"
}

variable "default_zone" {
  type        = string
  default     = "ru-central1-a"
  description = "https://cloud.yandex.ru/docs/overview/concepts/geo-scope"
}

variable "vpc_name" {
  type        = string
  default     = "develop"
  description = "VPC network & subnet name"
}

variable "cidr_a" {
  type        = list(string)
  default     = ["10.0.1.0/24"]
  description = "https://cloud.yandex.ru/docs/vpc/operations/subnet-create"
}

variable "cidr_b" {
  type        = list(string)
  default     = ["10.0.2.0/24"]
  description = "https://cloud.yandex.ru/docs/vpc/operations/subnet-create"
}

variable "vm_image_family" {
  type    = string
  default = "ubuntu-2204-lts"
  description = "Image family name"
}

##ssh

variable "vms_ssh_root_key" {
  type        = string
  default     = "ubuntu:ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAICBJOodclPNPYPA2pyGpmraEW7K7qzSFNOw7SFk9JxUq"
  description = "ssh-keygen -t ed25519"
}

```

**main.tf**

```
resource "yandex_vpc_network" "develop" {
  name = var.vpc_name
}

resource "yandex_vpc_subnet" "develop_a" {
  name           = "${var.vpc_name}-a"
  zone           = var.vm_web_zone
  network_id     = yandex_vpc_network.develop.id
  v4_cidr_blocks = var.cidr_a
}

resource "yandex_vpc_subnet" "develop_b" {
  name           = "${var.vpc_name}-b"
  zone           = var.vm_db_zone
  network_id     = yandex_vpc_network.develop.id
  v4_cidr_blocks = var.cidr_b
}

data "yandex_compute_image" "ubuntu" {
  family = var.vm_image_family
}

##vm_web
resource "yandex_compute_instance" "web" {
  name        = var.vm_web_name
  platform_id = var.vm_web_platform_id
  resources {
    cores         = var.vm_web_cores
    memory        = var.vm_web_memory
    core_fraction = var.vm_web_core_fraction
  }
  boot_disk {
    initialize_params {
      image_id = data.yandex_compute_image.ubuntu.image_id
    }
  }
  scheduling_policy {
    preemptible = var.vm_web_preemptible
  }
  network_interface {
    subnet_id = yandex_vpc_subnet.develop_a.id
    nat       = var.vm_web_nat
  }

  metadata = {
    serial-port-enable = var.vm_web_serial_port_enable
    ssh-keys           = var.vms_ssh_root_key
  }
}

##vm_db
resource "yandex_compute_instance" "db" {
  name        = var.vm_db_name
  platform_id = var.vm_db_platform_id
  zone           = var.vm_db_zone
  resources {
    cores         = var.vm_db_cores
    memory        = var.vm_db_memory
    core_fraction = var.vm_db_core_fraction
  }
  boot_disk {
    initialize_params {
      image_id = data.yandex_compute_image.ubuntu.image_id
    }
  }
  scheduling_policy {
    preemptible = var.vm_db_preemptible
  }
  network_interface {
    subnet_id = yandex_vpc_subnet.develop_b.id
    nat       = var.vm_db_nat
  }

  metadata = {
    serial-port-enable = var.vm_db_serial_port_enable
    ssh-keys           = var.vms_ssh_root_key
  }
}
```


Зоны доступности и подсети в Yandex Cloud

![Image alt](https://github.com/littlelucidlynx/ter-homeworks/blob/main/02/Screen/Image009.png)

Виртуальные машины

![Image alt](https://github.com/littlelucidlynx/ter-homeworks/blob/main/02/Screen/Image010.png)
3. Примените изменения.

## Задание 4

1. Содержимое **outputs.tf** с выводом instance_name, external_ip, fqdn для каждой из ВМ.

```
output "virtual_machines_output_information" {
  value = {
    vm_web = {
      instance_name = yandex_compute_instance.web.name
      external_ip   = yandex_compute_instance.web.network_interface.0.nat_ip_address
      fqdn          = yandex_compute_instance.web.fqdn
    }
    vm_db = {
      instance_name = yandex_compute_instance.db.name
      external_ip   = yandex_compute_instance.db.network_interface.0.nat_ip_address
      fqdn          = yandex_compute_instance.db.fqdn
    }
  }
}
```
Вывод

![Image alt](https://github.com/littlelucidlynx/ter-homeworks/blob/main/02/Screen/Image011.png)

В качестве решения приложите вывод значений ip-адресов команды ```terraform output```.


### Задание 5

1. Имя виртуальной машины формируется по принципу:
нетология-среда/контур-проект-имя
т.е.
netology-develop-platform-web
netology-develop-platform-db
2. Замените переменные внутри ресурса ВМ на созданные вами local-переменные.
3. Примените изменения.


### Задание 6

1. Вместо использования трёх переменных  ".._cores",".._memory",".._core_fraction" в блоке  resources {...}, объедините их в единую map-переменную **vms_resources** и  внутри неё конфиги обеих ВМ в виде вложенного map(object).  
   ```
   пример из terraform.tfvars:
   vms_resources = {
     web={
       cores=2
       memory=2
       core_fraction=5
       hdd_size=10
       hdd_type="network-hdd"
       ...
     },
     db= {
       cores=2
       memory=4
       core_fraction=20
       hdd_size=10
       hdd_type="network-ssd"
       ...
     }
   }
   ```
3. Создайте и используйте отдельную map(object) переменную для блока metadata, она должна быть общая для всех ваших ВМ.
   ```
   пример из terraform.tfvars:
   metadata = {
     serial-port-enable = 1
     ssh-keys           = "ubuntu:ssh-ed25519 AAAAC..."
   }
   ```  
  
5. Найдите и закоментируйте все, более не используемые переменные проекта.
6. Проверьте terraform plan. Изменений быть не должно.

------

## Дополнительное задание (со звёздочкой*)

**Настоятельно рекомендуем выполнять все задания со звёздочкой.**   
Они помогут глубже разобраться в материале. Задания со звёздочкой дополнительные, не обязательные к выполнению и никак не повлияют на получение вами зачёта по этому домашнему заданию. 


------
### Задание 7*

Изучите содержимое файла console.tf. Откройте terraform console, выполните следующие задания: 

1. Напишите, какой командой можно отобразить **второй** элемент списка test_list.
2. Найдите длину списка test_list с помощью функции length(<имя переменной>).
3. Напишите, какой командой можно отобразить значение ключа admin из map test_map.
4. Напишите interpolation-выражение, результатом которого будет: "John is admin for production server based on OS ubuntu-20-04 with X vcpu, Y ram and Z virtual disks", используйте данные из переменных test_list, test_map, servers и функцию length() для подстановки значений.

**Примечание**: если не догадаетесь как вычленить слово "admin", погуглите: "terraform get keys of map"

В качестве решения предоставьте необходимые команды и их вывод.

------

### Задание 8*
1. Напишите и проверьте переменную test и полное описание ее type в соответствии со значением из terraform.tfvars:
```
test = [
  {
    "dev1" = [
      "ssh -o 'StrictHostKeyChecking=no' ubuntu@62.84.124.117",
      "10.0.1.7",
    ]
  },
  {
    "dev2" = [
      "ssh -o 'StrictHostKeyChecking=no' ubuntu@84.252.140.88",
      "10.0.2.29",
    ]
  },
  {
    "prod1" = [
      "ssh -o 'StrictHostKeyChecking=no' ubuntu@51.250.2.101",
      "10.0.1.30",
    ]
  },
]
```
2. Напишите выражение в terraform console, которое позволит вычленить строку "ssh -o 'StrictHostKeyChecking=no' ubuntu@62.84.124.117" из этой переменной.
------

------

### Задание 9*

Используя инструкцию https://cloud.yandex.ru/ru/docs/vpc/operations/create-nat-gateway#tf_1, настройте для ваших ВМ nat_gateway. Для проверки уберите внешний IP адрес (nat=false) у ваших ВМ и проверьте доступ в интернет с ВМ, подключившись к ней через serial console. Для подключения предварительно через ssh измените пароль пользователя: ```sudo passwd ubuntu```

### Правила приёма работыДля подключения предварительно через ssh измените пароль пользователя: sudo passwd ubuntu
В качестве результата прикрепите ссылку на MD файл с описанием выполненой работы в вашем репозитории. Так же в репозитории должен присутсвовать ваш финальный код проекта.

**Важно. Удалите все созданные ресурсы**.


### Критерии оценки

Зачёт ставится, если:

* выполнены все задания,
* ответы даны в развёрнутой форме,
* приложены соответствующие скриншоты и файлы проекта,
* в выполненных заданиях нет противоречий и нарушения логики.

На доработку работу отправят, если:

* задание выполнено частично или не выполнено вообще,
* в логике выполнения заданий есть противоречия и существенные недостатки. 

