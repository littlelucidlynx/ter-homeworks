# Домашнее задание к занятию «Использование Terraform в команде»

## Чек-лист готовности к домашнему заданию

![Image alt](https://github.com/littlelucidlynx/ter-homeworks/blob/main/05/Screen/Image000.png)

В задании были созданы три ветки:

[main](https://github.com/littlelucidlynx/ter-homeworks/blob/main/05/hw-05.md) - Основное описание задания и валидация переменных

[terraform-05](https://github.com/littlelucidlynx/ter-homeworks/blob/terraform-05/05/hw-05.md) - tfstate в S3 и блокировки
[terraform-hotfix](https://github.com/littlelucidlynx/ter-homeworks/blob/terraform-hotfix/05/hw-05.md) - пулл реквест, изменения в terraform-05 не залиты

---

## Задание 1

1. ```tflint``` **Домашнее задание**

![Image alt](https://github.com/littlelucidlynx/ter-homeworks/blob/main/05/Screen/Image001.png)

2. Ошибки

[terraform_module_pinned_source](https://github.com/terraform-linters/tflint-ruleset-terraform/blob/v0.9.1/docs/rules/terraform_module_pinned_source.md)

[terraform_required_providers](https://github.com/terraform-linters/tflint-ruleset-terraform/blob/v0.9.1/docs/rules/terraform_required_providers.md)

[terraform_unused_declarations](https://github.com/terraform-linters/tflint-ruleset-terraform/blob/v0.9.1/docs/rules/terraform_unused_declarations.md)

3. ```tflint``` **Демонстрация**

![Image alt](https://github.com/littlelucidlynx/ter-homeworks/blob/main/05/Screen/Image002.png)

4. Ошибки

[terraform_module_pinned_source](https://github.com/terraform-linters/tflint-ruleset-terraform/blob/v0.9.1/docs/rules/terraform_module_pinned_source.md)

[terraform_required_providers](https://github.com/terraform-linters/tflint-ruleset-terraform/blob/v0.9.1/docs/rules/terraform_required_providers.md)

[terraform_unused_declarations](https://github.com/terraform-linters/tflint-ruleset-terraform/blob/v0.9.1/docs/rules/terraform_unused_declarations.md)

5. ```checkov``` **Домашнее задание**

![Image alt](https://github.com/littlelucidlynx/ter-homeworks/blob/main/05/Screen/Image003.png)

6. Ошибки

[`Check: CKV_TF_1: "Ensure Terraform module sources use a commit hash"`](https://docs.prismacloud.io/en/enterprise-edition/policy-reference/supply-chain-policies/terraform-policies/ensure-terraform-module-sources-use-git-url-with-commit-hash-revision)

[`Check: CKV_TF_2: "Ensure Terraform module sources use a tag with a version number"`](https://docs.prismacloud.io/en/enterprise-edition/policy-reference/supply-chain-policies/terraform-policies/ensure-terraform-module-sources-use-tag)

7. ```checkov``` **Демонстрация**

![Image alt](https://github.com/littlelucidlynx/ter-homeworks/blob/main/05/Screen/Image004.png)

8. Ошибки

[`Check: CKV_TF_1: "Ensure Terraform module sources use a commit hash"`](https://docs.prismacloud.io/en/enterprise-edition/policy-reference/supply-chain-policies/terraform-policies/ensure-terraform-module-sources-use-git-url-with-commit-hash-revision)

[`Check: CKV_TF_2: "Ensure Terraform module sources use a tag with a version number"`](https://docs.prismacloud.io/en/enterprise-edition/policy-reference/supply-chain-policies/terraform-policies/ensure-terraform-module-sources-use-tag)

---

## Задание 2

1. [Branch](https://github.com/littlelucidlynx/ter-homeworks/tree/terraform-05/04)

2. Запуск без облачного провайдера, tfstate лежит локально

![Image alt](https://github.com/littlelucidlynx/ter-homeworks/blob/main/05/Screen/Image008.png)

3. Бакет

![Image alt](https://github.com/littlelucidlynx/ter-homeworks/blob/main/05/Screen/Image005.png)

4. Папка

![Image alt](https://github.com/littlelucidlynx/ter-homeworks/blob/main/05/Screen/Image006.png)

5. Сервисный аккаунт

![Image alt](https://github.com/littlelucidlynx/ter-homeworks/blob/main/05/Screen/Image007.png)

6. Запуск с облачным провайдером. Terraform предлагает скопировать tfstate в новый backend

![Image alt](https://github.com/littlelucidlynx/ter-homeworks/blob/main/05/Screen/Image009.png)

7. Вот же он

![Image alt](https://github.com/littlelucidlynx/ter-homeworks/blob/main/05/Screen/Image010.png)

8. Содержимое по ссылке

![Image alt](https://github.com/littlelucidlynx/ter-homeworks/blob/main/05/Screen/Image011.png)

9. Запрос содержимого YDB

![Image alt](https://github.com/littlelucidlynx/ter-homeworks/blob/main/05/Screen/Image012.png)

10. Повторный apply, tfstate заблокирован (мною же)

![Image alt](https://github.com/littlelucidlynx/ter-homeworks/blob/main/05/Screen/Image013.png)

11. Принудительное снятие блокировки по id

![Image alt](https://github.com/littlelucidlynx/ter-homeworks/blob/main/05/Screen/Image014.png)

```
terraform force-unlock 34f7b7e4-6a99-8a8a-6f0c-8a92df0dd7d6
```

---

## Задание 3  

1. Исправление, проверка tflint и checkov

![Image alt](https://github.com/littlelucidlynx/ter-homeworks/blob/main/05/Screen/Image015.png)

2. Ссылка на [pull request](https://github.com/littlelucidlynx/ter-homeworks/pull/1)

---

## Задание 4

1. Проверка переменной через cidrhost

```
variable "ip_address_cidrhost" {
  description = "ip-адрес"
  type        = string
#  default     = "192.168.0.1"
  default     = "1920.1680.0.1"
  validation {
    condition     = can(cidrhost("${var.ip_address_cidrhost}/32", 0))
    error_message = "Неверный IP адрес - не соответствует шаблону"
  }
}
```

2. Проверка регуляркой

```
variable "ip_address_regex" {
  description = "ip-адрес"
  type        = string
#  default     = "192.168.0.1"
  default     = "1920.1680.0.1"
  validation {
    condition     = can(regex("^((25[0-5]|2[0-4][0-9]|1[0-9]{2}|[1-9]?[0-9])\\.){3}(25[0-5]|2[0-4][0-9]|1[0-9]{2}|[1-9]?[0-9])$", var.ip_address_regex))
    error_message = "Неверный IP адрес - не соответствует шаблону"
  }
}

variable "ip_address_list" {
  description = "список ip-адресов"
  type        = list(string)
#  default     = ["192.168.0.1", "1.1.1.1", "127.0.0.1"]
  default     = ["192.168.0.1", "1.1.1.1", "1270.0.0.1"]
  validation {
    condition = alltrue([for address in var.ip_address_list: can(regex("^((25[0-5]|2[0-4][0-9]|1[0-9]{2}|[1-9]?[0-9])\\.){3}(25[0-5]|2[0-4][0-9]|1[0-9]{2}|[1-9]?[0-9])$", address))])
    error_message = "Неверный список IP адресов - не соответствует шаблону"
  }
}
```
3. Вывод в консоли заведомо неверных дефолтных значений

![Image alt](https://github.com/littlelucidlynx/ter-homeworks/blob/main/05/Screen/Image016.png)