# Домашнее задание к занятию «Введение в Terraform»

### Цели задания

1. Установить и настроить Terrafrom.
2. Научиться использовать готовый код.

------

### Чек-лист готовности к домашнему заданию

![Image alt](https://github.com/littlelucidlynx/ter-homeworks/blob/main/01/Screen/Image000.png)

------

### Задание 1

1. Установка зеркального репозитория и скачивание зависимостей

```
cp ./.terraformrc ~/.terraformrc
terraform init
```

![Image alt](https://github.com/littlelucidlynx/ter-homeworks/blob/main/01/Screen/Image001.png)

2. В файле **.gitignore** перечислены локальные директории terraform, файлы текущего состояния инфраструктуры tfstate по маске и файл переменных personal.auto.tfvars.
В файле **personal.auto.tfvars** допустимо сохранить личную, секретную информацию (логины, пароли, ключи, токены итд)

![Image alt](https://github.com/littlelucidlynx/ter-homeworks/blob/main/01/Screen/Image002.png)

3. **"result": "Xx3QhAcKBKKeIX4h"**

![Image alt](https://github.com/littlelucidlynx/ter-homeworks/blob/main/01/Screen/Image003.png)

4. Ошибки

```
│ Error: Missing name for resource
│ 
│   on main.tf line 23, in resource "docker_image":
│   23: resource "docker_image" {
│ 
│ All resource blocks must have 2 labels (type, name).
```

Отсутствует **имя для объекта**. Блок resource должен содержать два лейбла: тип объекта из классификатора провайдера и уникальное имя в данном проекте

```
│ Error: Invalid resource name
│ 
│   on main.tf line 28, in resource "docker_container" "1nginx":
│   28: resource "docker_container" "1nginx" {
│ 
│ A name must start with a letter or underscore and may contain only letters, digits, underscores, and dashes.
```

Неверное имя объекта - **оно не может начинаться с цифры**. Уникальное имя должно начинаться с буквы или подчеркивания и может содержать в себе только буквы, цифры, подчеркивания и пробелы

```
│ Error: Reference to undeclared resource
│ 
│   on main.tf line 30, in resource "docker_container" "nginx":
│   30:   name  = "example_${random_password.random_string_FAKE.resulT}"
│ 
│ A managed resource "random_password" "random_string_FAKE" has not been declared in the root module.
```
Неверно указано имя ресурса **"random_string_FAKE"**. Ресурс с лейблами "random_password" "random_string_FAKE" не объявлен в проекте

```
│ Error: Unsupported attribute
│ 
│   on main.tf line 30, in resource "docker_container" "nginx":
│   30:   name  = "example_${random_password.random_string.resulT}"
│ 
│ This object has no argument, nested block, or exported attribute named "resulT". Did you mean "result"?
```
Неверно указан аттрибут **resulT** объекта - название чувствительно к регистру.

Ошибки исправлены, валидация прошла успешно

![Image alt](https://github.com/littlelucidlynx/ter-homeworks/blob/main/01/Screen/Image004.png)

5. Код выполнен

```
resource "docker_image" **"nginx"** {
  name         = "nginx:latest"
  keep_locally = true
}

resource "docker_container" **"nginx"** {
  image = docker_image.nginx.image_id
  name  = "example_${random_password.**random_string**.**result**}"

  ports {
    internal = 80
    external = 9090
  }
```
![Image alt](https://github.com/littlelucidlynx/ter-homeworks/blob/main/01/Screen/Image005.png)

6. Ключ **-auto-approve** применяет изменения инфраструктуры без вывода подтверждения. У пользователя не будет возможности оценить корректность плана выполнения и отловить ошибки. Полезно, если сценарий развертывания отлажен и не требует участия пользователя

![Image alt](https://github.com/littlelucidlynx/ter-homeworks/blob/main/01/Screen/Image006.png)

8. Уничтожение созданных ресурсов

```
terraform destroy
cat ./terraform.tfstate
```
![Image alt](https://github.com/littlelucidlynx/ter-homeworks/blob/main/01/Screen/Image007png)

9. Образ по-прежнему присутствует в системе

![Image alt](https://github.com/littlelucidlynx/ter-homeworks/blob/main/01/Screen/Image008png)

Удаление образа не произошло из-за опционального поля keep_locally. При значении true образ не удаляется при операции terraform destroy.

```
resource "docker_image" "nginx" {
  name         = "nginx:latest"
  **keep_locally = true**
}
```

![Image alt](https://github.com/littlelucidlynx/ter-homeworks/blob/main/01/Screen/Image009.png)

------

## Дополнительное задание (со звёздочкой*)

**Настоятельно рекомендуем выполнять все задания со звёздочкой.** Они помогут глубже разобраться в материале.   
Задания со звёздочкой дополнительные, не обязательные к выполнению и никак не повлияют на получение вами зачёта по этому домашнему заданию. 

### Задание 2*

1. Создайте в облаке ВМ. Сделайте это через web-консоль, чтобы не слить по незнанию токен от облака в github(это тема следующей лекции). Если хотите - попробуйте сделать это через terraform, прочитав документацию yandex cloud. Используйте файл ```personal.auto.tfvars``` и гитигнор или иной, безопасный способ передачи токена!
2. Подключитесь к ВМ по ssh и установите стек docker.
3. Найдите в документации docker provider способ настроить подключение terraform на вашей рабочей станции к remote docker context вашей ВМ через ssh.
4. Используя terraform и  remote docker context, скачайте и запустите на вашей ВМ контейнер ```mysql:8``` на порту ```127.0.0.1:3306```, передайте ENV-переменные. Сгенерируйте разные пароли через random_password и передайте их в контейнер, используя интерполяцию из примера с nginx.(```name  = "example_${random_password.random_string.result}"```  , двойные кавычки и фигурные скобки обязательны!) 
```
    environment:
      - "MYSQL_ROOT_PASSWORD=${...}"
      - MYSQL_DATABASE=wordpress
      - MYSQL_USER=wordpress
      - "MYSQL_PASSWORD=${...}"
      - MYSQL_ROOT_HOST="%"
```

6. Зайдите на вашу ВМ , подключитесь к контейнеру и проверьте наличие секретных env-переменных с помощью команды ```env```. Запишите ваш финальный код в репозиторий.

### Задание 3*
1. Установите [opentofu](https://opentofu.org/)(fork terraform с лицензией Mozilla Public License, version 2.0) любой версии
2. Попробуйте выполнить тот же код с помощью ```tofu apply```, а не terraform apply.
------

### Правила приёма работы

Домашняя работа оформляется в отдельном GitHub-репозитории в файле README.md.   
Выполненное домашнее задание пришлите ссылкой на .md-файл в вашем репозитории.

### Критерии оценки

Зачёт ставится, если:

* выполнены все задания,
* ответы даны в развёрнутой форме,
* приложены соответствующие скриншоты и файлы проекта,
* в выполненных заданиях нет противоречий и нарушения логики.

На доработку работу отправят, если:

* задание выполнено частично или не выполнено вообще,
* в логике выполнения заданий есть противоречия и существенные недостатки. 

